cmake_minimum_required(VERSION 4.0)
project(example LANGUAGES CXX)

# 1ï¸âƒ£ Pybind æ¨¡å—å®šä¹‰
add_library(example MODULE
    binding.cpp
    myclass.cpp
    myclass.h
)

# 4ï¸âƒ£ MSVC ç¯å¢ƒé…ç½®
if (MSVC)
    message(STATUS "ğŸ”§ Detected MSVC toolchain, enabling MFC/ATL support...")

    # ------------------------------------------------------------------
    # ã€å…³é”®å®šä¹‰ã€‘å¿…é¡»è®© MFC/ATL åœ¨ DLL æ¨¡å¼ä¸‹å·¥ä½œ
    # ------------------------------------------------------------------
    target_compile_definitions(example PRIVATE
        UNICODE
        _UNICODE
        _AFXDLL                         # ä½¿ç”¨å…±äº« MFC DLLï¼ˆé¿å…é™æ€é“¾æ¥å†²çªï¼‰
        _USRDLL
        _WINDOWS
        _WINDLL
        _ATL_CSTRING_EXPLICIT_CONSTRUCTORS
        VC_EXTRALEAN                    # ç²¾ç®€ MFC å¤´
        WIN32_LEAN_AND_MEAN             # ç²¾ç®€ Windows å¤´
    )

    # ------------------------------------------------------------------
    # ã€MFC/ATL å¿…è¦çš„åº“é“¾æ¥ã€‘
    # ------------------------------------------------------------------
    # âš ï¸ ä¸è¦åªå†™ mfc140u.lib / atls.libï¼Œå¿…é¡»è¡¥ä¸Šä¾èµ–çš„ç³»ç»Ÿåº“
    target_link_libraries(example PRIVATE
        mfc140u.lib
        atls.lib
        ole32.lib
        oleaut32.lib
        comdlg32.lib
        user32.lib
        gdi32.lib
        advapi32.lib
        shell32.lib
        uuid.lib
        uxtheme.lib
    )

    # ------------------------------------------------------------------
    # ã€åŒ…å«å¤´æ–‡ä»¶è·¯å¾„ã€‘
    # CMake ä¸ä¼šè‡ªåŠ¨æ‰¾åˆ° ATL/MFC çš„ includeï¼Œéœ€è¦æˆ‘ä»¬å¸®å®ƒå®šä½
    # ------------------------------------------------------------------
    file(GLOB VS_ATL_PATH
        "C:/Program Files/Microsoft Visual Studio/2022/*/VC/Tools/MSVC/*/atlmfc/include"
    )
    if (VS_ATL_PATH)
        message(STATUS "âœ… Found ATL/MFC include: ${VS_ATL_PATH}")
        target_include_directories(example PRIVATE ${VS_ATL_PATH})
    else()
        message(FATAL_ERROR "âŒ Could not locate ATL/MFC include path. Check VS installation.")
    endif()

    # ------------------------------------------------------------------
    # ã€ç”Ÿæˆé€‰é¡¹ã€‘
    # ------------------------------------------------------------------
    target_link_options(example PRIVATE
        /SUBSYSTEM:WINDOWS     # Windows æ¨¡å—ï¼ˆæ—  consoleï¼‰
        /NOLOGO
    )
endif()

# 6ï¸âƒ£ å¦‚æœæœ‰ shared.libï¼ˆè‡ªå·±çš„é¡¹ç›®åº“ï¼‰
target_link_libraries(example PRIVATE mysharedlib)


ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼
COMMAND
ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼
# 32-bit
cmake -G "Visual Studio 17 2022" -A Win32 -B build32
cmake --build build32 --config Release

# 64-bit
cmake -G "Visual Studio 17 2022" -A x64 -B build64
cmake --build build64 --config Release


ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼
ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼
ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼
C:\Program Files\Microsoft Visual Studio\2022\Community\VC\Tools\MSVC\<ç‰ˆæœ¬å·>\bin\Hostx64\x64\dumpbin.exe

2.	æœç´¢ï¼š
ğŸ” â€œx64 Native Tools Command Prompt for VS 2022â€
æˆ–
ğŸ” â€œx86 Native Tools Command Prompt for VS 2022â€


dumpbin /DEPENDENTS build64/example.pyd







cmake_minimum_required(VERSION 3.21)
project(example LANGUAGES CXX)

add_library(example MODULE
    binding.cpp
    myclass.cpp
    myclass.h
)

set_target_properties(example PROPERTIES
    PREFIX ""
    SUFFIX ".pyd"
)

target_compile_features(example PRIVATE cxx_std_17)

if (MSVC)
    message(STATUS "ğŸ”§ MSVC detected, enabling static MFC/ATL support")

    # æ£€æµ‹æ¶æ„
    if (CMAKE_SIZEOF_VOID_P EQUAL 8)
        set(ARCH_DIR "x64")
    else()
        set(ARCH_DIR "x86")
    endif()

    file(GLOB VS_ATL_PATH
        "C:/Program Files/Microsoft Visual Studio/2022/*/VC/Tools/MSVC/*/atlmfc/include"
    )
    file(GLOB VS_ATL_LIB
        "C:/Program Files/Microsoft Visual Studio/2022/*/VC/Tools/MSVC/*/atlmfc/lib/${ARCH_DIR}"
    )

    target_include_directories(example PRIVATE ${VS_ATL_PATH})
    link_directories(${VS_ATL_LIB})

    # âœ… é™æ€é“¾æ¥ MFC/ATL
    target_compile_options(example PRIVATE
        /MT            # é™æ€ CRT
        /MP            # å¤šæ ¸ç¼–è¯‘
    )

    # âŒ å»æ‰ _AFXDLLï¼Œä¸è¦å®šä¹‰
    target_compile_definitions(example PRIVATE
        UNICODE
        _UNICODE
        _USRDLL
        _WINDOWS
        _WINDLL
        _ATL_CSTRING_EXPLICIT_CONSTRUCTORS
        VC_EXTRALEAN
        WIN32_LEAN_AND_MEAN
    )

    # âœ… é“¾æ¥é™æ€åº“ç‰ˆæœ¬
    target_link_libraries(example PRIVATE
        mfcs140.lib     # é™æ€ MFC
        atls.lib        # é™æ€ ATL
        ole32.lib
        oleaut32.lib
        comdlg32.lib
        user32.lib
        gdi32.lib
        advapi32.lib
        shell32.lib
        uuid.lib
        uxtheme.lib
    )

    target_link_options(example PRIVATE
        /SUBSYSTEM:WINDOWS
        /NOLOGO
    )
endif()