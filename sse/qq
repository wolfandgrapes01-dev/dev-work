from flask import Flask, Response, request
from queue import Queue, Empty
import threading, time, json

app = Flask(__name__)

# 每个客户端一个消息队列
clients = []

def event_stream(q: Queue):
    """不断从 queue 取数据并推送给客户端"""
    while True:
        try:
            msg = q.get(timeout=60)  # 60秒无消息后自动超时（保持连接）
            yield f"data: {json.dumps(msg)}\n\n"
        except Empty:
            # 定期发个心跳防止连接超时
            yield "data: {\"type\": \"heartbeat\"}\n\n"

@app.route('/stream')
def stream():
    q = Queue()
    clients.append(q)
    return Response(event_stream(q), mimetype='text/event-stream')

@app.route('/send', methods=['POST'])
def send():
    """模拟其他逻辑触发消息"""
    data = request.json
    for q in clients:
        q.put(data)
    return "ok"

if __name__ == '__main__':
    app.run(threaded=True, debug=True)