import os
import re
import csv

# é…ç½®æ ¹ç›®å½•ï¼ˆè¯·ä¿®æ”¹ä¸ºä½ çš„å®é™…è·¯å¾„ï¼‰
root_dir = r"C:\path\to\your\root"

# åªåˆ†æä»¥ä¸‹æ‰©å±•å
extensions = ('.cpp', '.c', '.h', '.hpp')

# åŒ¹é… #include "xxx" æˆ– #include <xxx>
include_pattern = re.compile(r'#include\s+[<"](.+?)[>"]')

# å­˜å‚¨ä¾èµ–å…³ç³»
dependencies = []

for dirpath, dirnames, filenames in os.walk(root_dir):
    # ğŸš« è·³è¿‡ .svn æ–‡ä»¶å¤¹
    dirnames[:] = [d for d in dirnames if d.lower() != ".svn"]

    for filename in filenames:
        if filename.endswith(extensions):
            full_path = os.path.abspath(os.path.join(dirpath, filename))

            try:
                with open(full_path, 'r', encoding='utf-8', errors='ignore') as f:
                    for line in f:
                        match = include_pattern.search(line)
                        if match:
                            include_file = match.group(1)
                            include_path = None

                            # ä¼˜å…ˆæŸ¥æ‰¾åŒç›®å½•
                            candidate = os.path.join(dirpath, include_file)
                            if os.path.exists(candidate):
                                include_path = os.path.abspath(candidate)
                            else:
                                # åœ¨æ•´ä¸ªé¡¹ç›®ä¸­æŸ¥æ‰¾ï¼ˆæ’é™¤ .svnï¼‰
                                for root, subdirs, files in os.walk(root_dir):
                                    subdirs[:] = [d for d in subdirs if d.lower() != ".svn"]
                                    if os.path.basename(include_file) in files:
                                        include_path = os.path.abspath(os.path.join(root, include_file))
                                        break

                            dependencies.append((full_path, include_path or include_file))

            except PermissionError:
                print(f"âš ï¸ æ— æ³•è®¿é—®: {full_path}")
            except Exception as e:
                print(f"âš ï¸ è¯»å–é”™è¯¯ {full_path}: {e}")

# è¾“å‡º CSV
output_file = os.path.join(root_dir, "dependencies.csv")
with open(output_file, 'w', newline='', encoding='utf-8') as csvfile:
    writer = csv.writer(csvfile)
    writer.writerow(["source_file", "included_file"])
    writer.writerows(dependencies)

print(f"âœ… ä¾èµ–å…³ç³»å·²è¾“å‡ºåˆ°: {output_file}")