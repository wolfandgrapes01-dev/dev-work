import os
import re
import csv

# æ ¹ç›®å½•è·¯å¾„ï¼ˆä¿®æ”¹ä¸ºä½ çš„é¡¹ç›®æ ¹ç›®å½•ï¼‰
root_dir = r"C:\path\to\your\root"

# éœ€è¦åˆ†æçš„æ‰©å±•å
extensions = ('.cpp', '.c', '.h', '.hpp')

# include åŒ¹é…æ¨¡å¼
include_pattern = re.compile(r'#include\s+[<"](.+?)[>"]')

# ä¿å­˜ä¾èµ–æ•°æ®
dependencies = []

def find_src_dirs(root):
    """é€’å½’æŸ¥æ‰¾æ‰€æœ‰ src æ–‡ä»¶å¤¹çš„è·¯å¾„"""
    src_dirs = []
    for dirpath, dirnames, _ in os.walk(root):
        # è·³è¿‡ .svn
        dirnames[:] = [d for d in dirnames if d.lower() != ".svn"]
        for d in dirnames:
            if d.lower() == "src":
                src_dirs.append(os.path.join(dirpath, d))
    return src_dirs


def analyze_includes(src_dir):
    """åˆ†ææŒ‡å®š src ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶çš„ #include ä¾èµ–"""
    for dirpath, dirnames, filenames in os.walk(src_dir):
        dirnames[:] = [d for d in dirnames if d.lower() != ".svn"]

        for filename in filenames:
            if filename.endswith(extensions):
                full_path = os.path.abspath(os.path.join(dirpath, filename))
                try:
                    with open(full_path, 'r', encoding='utf-8', errors='ignore') as f:
                        for line in f:
                            match = include_pattern.search(line)
                            if match:
                                include_file = match.group(1)
                                include_path = None

                                # ä¼˜å…ˆåœ¨åŒç›®å½•ä¸‹æŸ¥æ‰¾
                                candidate = os.path.join(dirpath, include_file)
                                if os.path.exists(candidate):
                                    include_path = os.path.abspath(candidate)
                                else:
                                    # åœ¨æ•´ä¸ªæ ¹ç›®å½•ä¸­æŸ¥æ‰¾åŒ¹é…æ–‡ä»¶ï¼ˆæ’é™¤ .svnï¼‰
                                    for root, subdirs, files in os.walk(root_dir):
                                        subdirs[:] = [d for d in subdirs if d.lower() != ".svn"]
                                        if os.path.basename(include_file) in files:
                                            include_path = os.path.abspath(os.path.join(root, include_file))
                                            break

                                dependencies.append((full_path, include_path or include_file))
                except PermissionError:
                    print(f"âš ï¸ æ— æ³•è®¿é—®: {full_path}")
                except Exception as e:
                    print(f"âš ï¸ è¯»å–é”™è¯¯ {full_path}: {e}")


# ä¸»æµç¨‹
src_dirs = find_src_dirs(root_dir)
print(f"ğŸ” æ‰¾åˆ° {len(src_dirs)} ä¸ª src æ–‡ä»¶å¤¹")
for src in src_dirs:
    print(f"  â†’ åˆ†æ: {src}")
    analyze_includes(src)

# è¾“å‡ºç»“æœ
output_file = os.path.join(root_dir, "dependencies.csv")
with open(output_file, 'w', newline='', encoding='utf-8') as csvfile:
    writer = csv.writer(csvfile)
    writer.writerow(["source_file", "included_file"])
    writer.writerows(dependencies)

print(f"\nâœ… ä¾èµ–å…³ç³»å·²è¾“å‡ºåˆ°: {output_file}")